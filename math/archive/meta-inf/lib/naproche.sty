\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage{naproche}{2025-09-28}{v1.0.0}{Advanced LaTeX package for Naproche formalization}

\RequirePackage{stex}
\RequirePackage{stex-highlighting}
\RequirePackage{amsmath,amssymb,amsfonts}
\RequirePackage{etoolbox}
\RequirePackage{xcolor}
\RequirePackage{keyval}
\RequirePackage{marginnote}
\RequirePackage{mdframed}
\RequirePackage{url}
\RequirePackage{xspace}
\RequirePackage{linegoal}
\RequirePackage{soul}


% Preliminary Setup
% -----------------

\bool_new:N \c_naproche_forthel_bool
\bool_set_false:N \c_naproche_forthel_bool

\bool_new:N \c_naproche_show_tls_numbers_bool
\bool_set_true:N \c_naproche_show_tls_numbers_bool

\bool_new:N \c_naproche_numbers_within_section_bool
\bool_set_false:N \c_naproche_numbers_within_section_bool

\bool_new:N \c_naproche_numbers_within_subsection_bool
\bool_set_false:N \c_naproche_numbers_within_subsection_bool

\newcounter {theoremcount}

\colorlet {forthelgray} {lightgray!30}

\colorlet {defcolor} {violet}
\colorlet {refcolor} {teal}


% Package Options
% ---------------

\keys_define:nn {naproche/package}
  {
    numberswithinsection    .bool_set:N = \c_naproche_numbers_within_section_bool,
    numberswithinsubsection .bool_set:N = \c_naproche_numbers_within_subsection_bool,
    unknown                 .code:n     = {
      \PackageError {naproche} {Unknown~package~option~"#1"}
        {
          The~following~options~are~supported:\MessageBreak
          -~"numberswithinsection"\MessageBreak
          -~"numberswithinsubsection"
        }
    }
  }

\ProcessKeysOptions {naproche/package}


% Logos
% -----

\NewDocumentCommand \Naproche {} {\mbox{\ensuremath{\mathbb{N}}aproche}\xspace}
\NewDocumentCommand \ForTheL {} {\mbox{ForTheL}\xspace}


% Comprehension terms
% -------------------

\NewDocumentCommand \classtext {m} {\parbox{\linegoal}{#1}}


% Top-level Section Environments
% ------------------------------

% Show/hide TLS numbers:
\NewDocumentCommand \ShowTlsNumbers {} {\bool_set_true:N \c_naproche_show_tls_numbers_bool}
\NewDocumentCommand \HideTlsNumbers {} {\bool_set_false:N \c_naproche_show_tls_numbers_bool}

\keys_define:nn {naproche/tls} {
  forthel .default:n  = {true},
  forthel .bool_set:N = \l_naproche_tls_key_forthel_bool,
  title   .default:n  = {},
  title   .tl_set:N   = \l_naproche_tls_key_title_tl,
  name    .default:n  = {},
  name    .tl_set:N   = \l_naproche_tls_key_name_tl,
  for     .default:n  = {},
  for     .tl_set:N   = \l_naproche_tls_key_for_tl,s
  unknown .code:n     = {
    \PackageError {naproche} {Unknown~key~"#1"~in~top-level~section~environment} {
      The~following~keys~are~supported:\MessageBreak
      -~"forthel"\MessageBreak
      -~"title"\MessageBreak
      -~"name"\MessageBreak
      -~"for"
    }
  }
}

% Create a new starred and a new unstarred top-level section environment.
% #1: environment name (e.g. "axiom")
% #2: header (e.g. "Axiom")
\cs_new:Npn \naproche_new_tls_env:nn #1 #2 {
  \NewDocumentEnvironment {#1} {O{} +b} {
    \keys_set:nn {naproche/tls} {##1}
    \tl_put_left:Nn \l_naproche_tls_key_for_tl \l_naproche_tls_key_name_tl
    \exp_args:Nne \naproche_tls_env:nnnn {#2} \l_naproche_tls_key_for_tl {##2} \c_false_bool
  } {}
  \NewDocumentEnvironment {#1*} {O{} +b} {
    \keys_set:nn {naproche/tls} {##1}
    \tl_put_left:Nn \l_naproche_tls_key_for_tl \l_naproche_tls_key_name_tl
    \exp_args:Nne \naproche_tls_env:nnnn {#2} \l_naproche_tls_key_for_tl {##2} \c_true_bool
  } {}
}

\bool_new:N \l_naproche_is_starred_env_bool
\bool_new:N \l_naproche_forthel_before_env_bool

% A top-level section environment.
% #1: header (e.g. "Axiom")
% #2: "for"-list
% #3: environment body
% #4: Boolean value that determines whether the environment is starred or not
\cs_new:Npn \naproche_tls_env:nnnn #1 #2 #3 #4 {%
  \bool_set:Nn \l_naproche_is_starred_env_bool {#4}
  \bool_set:Nn \l_naproche_forthel_before_env_bool \c_naproche_forthel_bool
  \bool_if:NF \l_naproche_forthel_before_env_bool {
    \bool_if:NTF \l_naproche_tls_key_forthel_bool {
      \begin {forthel}
    } {
      \par
      \addvspace \baselineskip
    }
  }
  \bool_if:NF \l_naproche_is_starred_env_bool {
    \bool_if:NT \c_naproche_show_tls_numbers_bool {
      \refstepcounter {theoremcount}
    }
  }
  \noindent
  \group_begin:
  \bfseries
  {#1}
  \bool_if:NF \l_naproche_is_starred_env_bool {
    \bool_if:NT \c_naproche_show_tls_numbers_bool {~\thetheoremcount}
  }
  \tl_if_empty:NF  \l_naproche_tls_key_title_tl {~(\l_naproche_tls_key_title_tl)}
  {.~}
  \group_end:
  \inlinedef [for={#2}] {#3}
  \bool_if:NF \l_naproche_forthel_before_env_bool {
    \par
    \bool_if:NTF \l_naproche_tls_key_forthel_bool {
      \end {forthel} % Sets \c_naproche_forthel_bool to false!
    } {
      \par
      \addvspace \baselineskip
    }
  }
  \bool_set:Nn \c_naproche_forthel_bool \l_naproche_forthel_before_env_bool % Rest \c_naproche_forthel_bool if it was changed by \end{forthel} above
}

% Create new (starred and unstarred) environments for each top-level section:
\naproche_new_tls_env:nn {definition} {Definition}
\naproche_new_tls_env:nn {signature} {Signature}
\naproche_new_tls_env:nn {axiom} {Axiom}
\naproche_new_tls_env:nn {theorem} {Theorem}
\naproche_new_tls_env:nn {lemma} {Lemma}
\naproche_new_tls_env:nn {proposition} {Proposition}
\naproche_new_tls_env:nn {corollary} {Corollary}
\naproche_new_tls_env:nn {convention} {Convention}


% The Proof Environment
% ---------------------

\keys_define:nn {naproche/proof} {
  forthel .default:n  = {true},
  forthel .bool_set:N = \l_naproche_proof_key_forthel_bool,
  method  .default:n  = {},
  method  .tl_set:N   = \l_naproche_proof_key_method_tl,
  unknown .code:n     = {
    \PackageError {naproche/proof} {Unknown~key~"#1"~in~proof~environment} {
      The~following~keys~are~supported:\MessageBreak
      -~"forthel"\MessageBreak
      -~"method"
    }
  }
}

\int_zero_new:N \l_naproche_proof_depth_int

\NewDocumentEnvironment {proof} {O{}} {
  \keys_set:nn {naproche/proof} {#1}
  \bool_set:Nn \l_naproche_forthel_before_env_bool \c_naproche_forthel_bool
  \bool_if:NTF \l_naproche_forthel_before_env_bool {
    \par
  } {
    \bool_if:NTF \l_naproche_proof_key_forthel_bool {
      \begin {forthel}
    } {
      \par
      \addvspace \baselineskip
    }
  }
  \noindent
  \group_begin:
  \itshape
  Proof
  \tl_if_empty:NF \l_naproche_proof_key_method_tl {~by~\l_naproche_proof_key_method_tl}
  {.~}
  \group_end:
  \int_incr:N \l_naproche_proof_depth_int
}
{
  \int_compare:nNnTF \l_naproche_proof_depth_int > 1 {
    \ensuremath \square
  } {
    \strut
    \hfill
    \ensuremath \blacksquare
  }
  \bool_if:NF \l_naproche_forthel_before_env_bool {
    \bool_if:NTF \l_naproche_proof_key_forthel_bool {
      \end {forthel}  % Sets \c_naproche_forthel_bool to false!
    }{
      \par
      \addvspace \baselineskip
    }
  }
  \bool_set:Nn \c_naproche_forthel_bool \l_naproche_forthel_before_env_bool % Rest \c_naproche_forthel_bool if it was changed by \end{forthel} above
  \int_decr:N \l_naproche_proof_depth_int
}


% The Case Environment
% --------------------

\NewCommandCopy \naproche@list \list
\NewCommandCopy \naproche@endlist \endlist

\NewDocumentEnvironment {case} {m} {
  \naproche@list {} {
    \setlength \leftmargin {1em}
    \setlength \topsep {0cm}
  }
  \item \textit {Case~#1}
} {
  \ensuremath \square
  \naproche@endlist
}


% The ForTheL Environment
% -----------------------

\NewDocumentEnvironment {forthel} {} {
  \par
  \addvspace \baselineskip
  \ifstexhtml
    \begin {stex_annotate_env} {style:class=forthel,rustex:block=true,rustex:sized=-20}
  \else
    \begin {mdframed} [backgroundcolor=forthelgray,linecolor=forthelgray]
  \fi
  \rmfamily
  \bool_set_true:N \c_naproche_forthel_bool
  \setlength \parindent {0pt}
  \setlength \parskip {0.5em}
}{
  \ifstexhtml
    \end {stex_annotate_env}
  \else
    \end {mdframed}
  \fi
  \rmfamily
  \bool_set_false:N \c_naproche_forthel_bool
  \par
  \addvspace \baselineskip
}


% The Inline ForTheL Command
% --------------------------

\NewDocumentCommand \inlineforthel {m} {
  \ifstexhtml
    #1
  \else
    \group_begin:
    \sethlcolor {forthelgray}
    \hl {#1}
    \group_end:
  \fi
}


% Highlighting Definientia and Symbol References
% ----------------------------------------------

\bool_new:N \c_naproche_emph_bool
\bool_set_false:N \c_naproche_emph_bool

\NewCommandCopy \naproche@oldemph \emph

\RenewDocumentCommand \emph {m} {
  \bool_set_true:N \c_naproche_emph_bool
  \bool_if:NTF \c_naproche_forthel_bool {
    \group_begin:
    \color {defcolor}
    \ifmmode \else \itshape \fi
    #1
    \group_end:
  } {
    \naproche@oldemph {#1}
  }
  \bool_set_false:N \c_naproche_emph_bool
}

\RenewDocumentCommand \varemph {m} {
  \bool_if:NTF \c_naproche_emph_bool {
    \textcolor {defcolor} {#1}
  } {
    \textcolor {refcolor} {#1}
  }
}

\RenewDocumentCommand \compemph {m} {
  \bool_if:NTF \c_naproche_emph_bool {
    \textcolor {defcolor} {#1}
  } {
    \textcolor {refcolor} {#1}
  }
}
