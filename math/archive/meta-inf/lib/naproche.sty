\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{naproche}[2025-09-28 v1.0.0 Advanced LaTeX package for Naproche formalization]

\RequirePackage{stex}
\RequirePackage{amsmath,amssymb,amsfonts}
\RequirePackage{etoolbox}
\RequirePackage{xcolor}
\RequirePackage{keyval}
\RequirePackage{marginnote}
\RequirePackage{mdframed}
\RequirePackage{url}
\RequirePackage{xspace}
\RequirePackage{linegoal}


% Logos
% -----

\NewDocumentCommand{\Naproche}{}{\mbox{\ensuremath{\mathbb{N}}aproche}\xspace}
\NewDocumentCommand{\ForTheL}{}{\mbox{ForTheL}\xspace}


% Comprehension terms
% -------------------

\newcommand{\classtext}[1]{\parbox{\linegoal}{#1}}


% Top-level sections
% ------------------

\newcounter{theoremcount}

\newbool{printid}
\setbool{printid}{false} % Set to true in naproche-library.cls
\newbool{showtlsnumber}
\setbool{showtlsnumber}{true}

% Show/hide TLS numbers:
\newcommand\showtlsnumbers{\setbool{showtlsnumber}{true}}
\newcommand\hidetlsnumbers{\setbool{showtlsnumber}{false}}

\newcommand\tlstitle{}
\newcommand\tlsname{}
\newcommand\tlsfor{}

\makeatletter
\define@key{tlskeys}{forthel}[true]{\setbool{forthel}{\if\relax{#1}{false}\else#1\fi}}
\define@key{tlskeys}{title}{\def\tlstitle{#1}}
\define@key{tlskeys}{name}{\def\tlsname{#1}}
\define@key{tlskeys}{for}{\def\tlsfor{#1}}
\makeatother


\ExplSyntaxOn

% Create a new starred and a new unstarred top-level section environment.
% #1: environment name (e.g. "axiom")
% #2: header (e.g. "Axiom")
\cs_new:Npn \naproche_new_tls_env:nn #1 #2 {
  \NewDocumentEnvironment{#1}{O{} +b}{
    \setkeys{tlskeys}{##1}
    \exp_args:Nne \naproche_tls_env:nnnn {#2} {\tlsfor,\tlsname} {##2} \c_false_bool
  }{}
  \NewDocumentEnvironment{#1*}{O{} +b}{
    \setkeys{tlskeys}{##1}
    \exp_args:Nne \naproche_tls_env:nnnn {#2} {\tlsfor,\tlsname} {##2} \c_true_bool
  }{}
}

% A top-level section environment.
% #1: header (e.g. "Axiom")
% #2: "for"-list
% #3: environment body
% #4: Boolean value that determines whether the environment is starred or not
\cs_new:Npn \naproche_tls_env:nnnn #1 #2 #3 #4 {%
  \bool_set:Nn \l_is_starred_env {#4}
  \setbool{forthelBeforeEnv}{\ifbool{forthel}{true}{false}}% Save the current value of the `forthel' variable
  \ifbool{forthelBeforeEnv}{}{\ifbool{forthel}{\begin{forthel}}{\par\addvspace{\baselineskip}}}%
  \bool_if:NF \l_is_starred_env
    {\refstepcounter{theoremcount}}
  \bool_if:NTF \l_is_starred_env
    {\noindent\textbf{#1\if\relax\tlstitle\else{~(\tlstitle)}\fi.~}}
    {\noindent\textbf{#1\ifbool{showtlsnumber}{~\thetheoremcount}{}\if\relax\tlstitle\else{~(\tlstitle)}\fi.~}}
  \inlinedef[for={#2}]{#3}
  \ifbool{forthelBeforeEnv}{\par}{\ifbool{forthel}{\end{forthel}}{\par\addvspace{\baselineskip}}}%
  \setbool{forthel}{\ifbool{forthelBeforeEnv}{true}{false}}% Reset the `forthel' variable
  \renewcommand\tlstitle{}%
  \renewcommand\tlsname{}%
  \renewcommand\tlsfor{}%
}

% Create new (starred and unstarred) environments for each top-level section:
\naproche_new_tls_env:nn {definition} {Definition}
\naproche_new_tls_env:nn {signature} {Signature}
\naproche_new_tls_env:nn {axiom} {Axiom}
\naproche_new_tls_env:nn {theorem} {Theorem}
\naproche_new_tls_env:nn {lemma} {Lemma}
\naproche_new_tls_env:nn {proposition} {Proposition}
\naproche_new_tls_env:nn {corollary} {Corollary}
\naproche_new_tls_env:nn {convention} {Convention}

\ExplSyntaxOff


\newcommand\proofmethod{}

\makeatletter
\define@key{proofkeys}{forthel}[true]{\setbool{forthel}{\if\relax{#1}{false}\else#1\fi}}
\define@key{proofkeys}{method}{\def\proofmethod{#1}}
\makeatother

\newcounter{proofdepth}

\newenvironment{proof}[1][]{%
  \setbool{forthelBeforeEnv}{\ifbool{forthel}{true}{false}}% Save the current value of the `forthel' variable
  \setkeys{proofkeys}{#1}%
  \ifbool{forthelBeforeEnv}{\par}{\ifbool{forthel}{\begin{forthel}}{\par\addvspace{\baselineskip}}}%
  \noindent\textit{Proof\if\relax\proofmethod\else\ by \proofmethod\fi. }%
  \relax%
  % Reset the proof method so that it is not reused by subproofs:
  \def\proofmethod{}%
  \stepcounter{proofdepth}%
}
{%
  \ifnum\value{proofdepth}>1\ensuremath\square\else\strut\hfill\ensuremath\blacksquare\fi%
  \ifbool{forthelBeforeEnv}{}{\ifbool{forthel}{\end{forthel}}{\par\addvspace{\baselineskip}}}%
  \setbool{forthel}{\ifbool{forthelBeforeEnv}{true}{false}}% Reset the `forthel' variable
  % Reset the proof method so that it is not reused by following proofs:
  \def\proofmethod{}%
  \addtocounter{proofdepth}{-1}%
}

\makeatletter
% to prevent \list from being redefined, e.g. by a \symdef:
\let\@latexlist\list
\let\@endlatexlist\endlist
\newenvironment{case}[1]{%
  \@latexlist{}{
    \setlength\leftmargin{1em}
    \setlength\topsep{0cm}
  }
  \item\textit{Case #1}%
}
{%
  \ensuremath\square%
  \@endlatexlist
}
\makeatother


% ForTheL Environment
% -------------------

\colorlet{forthelgray}{lightgray!30}

% Space between paragraphs in forthel environments
\newlength{\ftlparskip}
\setlength{\ftlparskip}{0.5em}

\newbool{forthel}
\setbool{forthel}{false}

\newbool{forthelBeforeEnv}
\newbool{forthelInEnv}

% ForTheL environment
\newenvironment{forthel}{%
  \par\addvspace{\baselineskip}
  \ifstexhtml
    \begin{stex_annotate_env}{style:class=forthel,rustex:block=true,rustex:sized=-20}
  \else
    \begin{mdframed}[backgroundcolor=forthelgray,linecolor=forthelgray]%
  \fi
  \rmfamily%
  \setbool{forthel}{true}%
  \setlength{\parindent}{0pt}%
  \setlength{\parskip}{\ftlparskip}%
}{%
  \ifstexhtml
    \end{stex_annotate_env}%
  \else
    \end{mdframed}
  \fi
  \rmfamily%
  \setbool{forthel}{false}%
  \par\addvspace{\baselineskip}
}


% Inline ForTheL Command
% ----------------------

\RequirePackage{tcolorbox}
\RequirePackage{soulpos}

\newtcbox\ftlbox{
  on line,
  arc=0pt,
  outer arc=0pt,
  colback=forthelgray,
  colframe=forthelgray,
  boxsep=0pt,
  left=.2em,
  right=.2em,
  top=.2em,
  bottom=.4em,
  boxrule=0pt,
  height=1.4em    
}

\ulposdef\inlineforthelbox[xoffset-start=.2em]{%
  \ftlbox{\rule\ulwidth{0pt}}%
}

\newcommand\inlineforthel[1]{%
  \setbool{forthel}{true}%
  \inlineforthelbox{#1}%
  \setbool{forthel}{false}%
}


% \emph
% -----

\RequirePackage{stex-highlighting}
\newbool{emph}
\setbool{emph}{false}
\colorlet{emphcolor}{violet}
\let\oldemph\emph
\renewcommand\emph[1]{\setbool{emph}{true}\ifbool{forthel}{\textcolor{emphcolor}{\ifmmode#1\else\itshape#1\fi}}{\oldemph{#1}}\setbool{emph}{false}}
\renewcommand\varemph[1]{\ifbool{emph}{\textcolor{emphcolor}{#1}}{\textcolor{teal}{#1}}}
\renewcommand\compemph[1]{\ifbool{emph}{\textcolor{emphcolor}{#1}}{\textcolor{teal}{#1}}}


% Options
% -------

\DeclareOption{numberswithinsection}{%
  \counterwithin{theoremcount}{section}
}
\DeclareOption{numberswithinsubsection}{%
  \counterwithin{theoremcount}{subsection}
}
\DeclareOption*{\PackageWarning{naproche}{Unknown ‘\CurrentOption’}}
\ProcessOptions\relax
