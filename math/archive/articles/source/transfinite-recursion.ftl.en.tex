\documentclass{stex}
\libusepackage{naproche}
\libusepackage{copyright}
\libinput{preamble}

\title{The Transfinite Recursion Theorem in \Naproche}
\author{Marcel Schütz}
\date{2025}

\begin{document}
\begin{smodule}{transfinite-recursion.ftl}
\maketitle

\importmodule[libraries/set-theory]{transfinite-induction.ftl}
\importmodule[libraries/set-theory]{recursive-maps.ftl}

\symdecl*{coincidence lemma}

\noindent This is a formalization of the \emph{Transfinite Recursion Theorem}
(cf. \cite{Koepke2018}).
It states that for any map $G \FUNfromto{\ORDfunspace{A}}{A}$, where
$\ORDfunspace{A}$ denotes the class of all maps $\alpha \to A$ for some
ordinal $\alpha$, there exists a unique map $F \FUNfromto{\Ord}{A}$ that is
\emph{recursive regarding} $G$, i.e. \[F(\alpha) \Eq G(F \FUNrest \alpha)\] for
all ordinals $\alpha$.

\begin{lemma}[forthel,title=Coincidence Lemma,name=coincidence lemma]
  Let $A$ be a class and $G$ be a map from $\ORDfunspace{A}$ to $A$.
  Let $H, H'$ be maps to $A$ that are recursive regarding $G$.
  Then \[ H(\alpha) \Eq H'(\alpha) \] for all $\alpha \Elem \Dom(H) \SETintersect \Dom(H')$.
\end{lemma}
\begin{proof}[forthel]
  Define $\Phi \DefEq \SClass{\alpha}{\Ord}{\text{ if }
  \alpha \Elem \Dom(H) \SETintersect \Dom(H')\text{ then }H(\alpha) \Eq H'(\alpha)}$.

  For all ordinals $\alpha$ if every ordinal less than $\alpha$ lies in $\Phi$ then $\alpha \Elem \Phi$.
  \begin{proof}
    Let $\alpha \Elem \Ord$.
    Assume that every $y \Elem \alpha$ lies in $\Phi$.

    Let us show that if $\alpha \Elem \Dom(H) \SETintersect \Dom(H')$ then
    $H(\alpha) \Eq H'(\alpha)$.
      Suppose $\alpha \Elem \Dom(H) \SETintersect \Dom(H')$.
      Then $\alpha \SETinclude \Dom(H), \Dom(H')$.
      Indeed $\Dom(H)$ and $\Dom(H')$ are transitive classes.
      Hence for all $y \Elem \alpha$ we have $y \Elem\linebreak \Dom(H) \SETintersect \Dom(H')$.
      Thus $H(y) \Eq H'(y)$ for all $y \Elem \alpha$.
      Therefore $H \FUNrest \alpha \Eq\linebreak H' \FUNrest \alpha$.
      $H$ and $H'$ are recursive regarding $G$.
      We have $H \FUNrest \alpha, H' \FUNrest \alpha \Elem \ORDfunspace{A}$.
      Hence $H(\alpha)
        \Eq G(H \FUNrest \alpha)
        \Eq G(H' \FUNrest \alpha)
        \Eq H'(\alpha)$.
    End.

    Thus $\alpha \Elem \Phi$.
  \end{proof}

  [prover vampire]
  Then $\Phi$ contains every ordinal (by \sr{transfinite induction I}{transfinite induction}).
  Therefore we have $H(\alpha) \Eq H'(\alpha)$ for all $\alpha \Elem \Dom(H) \SETintersect \Dom(H')$.
\end{proof}

\begin{theorem}[forthel,title=Transfinite Recursion: Existence]
  Let $A$ be a class and $G$ be a map from $\ORDfunspace{A}$ to $A$.
  Then there exists a map $F$ from $\Ord$ to $A$ that is recursive regarding $G$.
\end{theorem}
\begin{proof}[forthel]
  Every ordinal is contained in the domain of some map $H$ to $A$ such that $H$ is recursive regarding $G$.
  \begin{proof}
    Define \[ \Phi \DefEq \SClass{\alpha}{\Ord}{\classtext{$\alpha$ is contained in the domain of some map to $A$ that is recursive regarding $G$}}. \]

    Let us show that for every ordinal $\alpha$ if every ordinal less than $\alpha$ lies in $\Phi$ then $\alpha \Elem \Phi$.
      Let $\alpha$ be an ordinal.
      Assume that every ordinal less than $\alpha$ lies in $\Phi$.
      Then for all $y \Elem \alpha$ there exists a map $h$ to $A$ such that $h$ is recursive regarding $G$ and $y \Elem \Dom(h)$.
      Define $H'(y) =$ ``choose a map $h$ to $A$ such that $h$ is recursive regarding $G$ and $y \Elem \Dom(h)$ in $h(y)$'' for $y \Elem \alpha$.
      Then $H'$ is a map from $\alpha$ to $A$.
      We have $H' \Eq H' \FUNrest \alpha$.
      Define \[ H(\beta) =
        \begin{cases}
          H'(\beta)                 & : \beta \ORDless \alpha \\
          G(H' \FUNrest \beta)  & : \beta \Eq \alpha
        \end{cases} \]
      for $\beta \Elem \ORDsucc(\alpha)$.
      
      Let us show that $H \FUNrest \beta \Elem \ORDfunspace{A}$ for all $\beta \Elem \Dom(H)$.
        Let $\beta \Elem \Dom(H)$.
        $\Dom(H \FUNrest \beta) \Eq \beta$ and $(H \FUNrest \beta)(b) \Eq H(b)$ for all $b \Elem \beta$.
        $H(b) \Elem A$ for all $b \Elem \beta$.
        Hence $H \FUNrest \beta$ is a map from $\beta$ to $A$.
      End.

      (a) $\Dom(H)$ is a transitive subclass of $\Ord$.

      (b) For all $\beta \Elem \Dom(H)$ we have $H(\beta) \Eq G(H \FUNrest \beta)$.
      \begin{proof}
        Let $\beta \Elem \Dom(H)$.
        Then $\beta \ORDless \alpha$ or $\beta \Eq \alpha$.

        \begin{case}{$\beta \ORDless \alpha$.}
          Choose a map $h$ to $A$ such that $h$ is recursive regarding $G$ and $\beta \Elem \Dom(h)$ and $H'(\beta) \Eq h(\beta)$.

          Let us show that for all $y \Elem \beta$ we have $h(y) \Eq H(y)$.
            Let $y \Elem \beta$.
            Then $H(y) \Eq H'(y)$.
            Choose a map $h'$ to $A$ such that $h'$ is recursive regarding $G$ and $y \Elem \Dom(h')$ and $H'(y) \Eq h'(y)$.
            [prover vampire]
            Then $h'(y) \Eq h(y)$ (by \sn{coincidence lemma}).
            Indeed $y \Elem \Dom(h) \SETintersect \Dom(h')$.
          End.

          Hence $h \FUNrest \beta \Eq H \FUNrest \beta$.
          Thus $H(\beta)
            \Eq H'(\beta)
            \Eq h(\beta)
            \Eq G(h \FUNrest \beta)
            \Eq G(H \FUNrest \beta)$.
        \end{case}

        \begin{case}{$\beta \Eq \alpha$.}
          We have $H \FUNrest \alpha \Eq H' \FUNrest \alpha$.
        \end{case}
      \end{proof}

      Hence $H$ is a map to $A$ such that $H$ is recursive regarding $G$ and $\alpha \Elem \Dom(H)$.
      Thus $\alpha \Elem \Phi$.
    End.

    [prover vampire]
    Therefore $\Phi$ contains every ordinal (by \sr{transfinite induction I}{transfinite induction}).
    Consequently every ordinal is contained in the domain of some map $H$ to $A$ such that $H$ is recursive regarding $G$.
  \end{proof}

  Define $F(\alpha) =$ ``choose a map $H$ to $A$ such that $H$ is recursive regarding $G$ and $\alpha \Elem \Dom(H)$ in $H(\alpha)$'' for $\alpha \Elem \Ord$.
  Then $F$ is a map from $\Ord$ to $A$.

  $F$ is recursive regarding $G$.
  \begin{proof}
    (a) $\Dom(F)$ is a transitive subclass of $\Ord$.

    (b) For all $\alpha \Elem \Ord$ we have $F(\alpha) \Eq G(F \FUNrest \alpha)$.
    \begin{proof}
      Let $\alpha \Elem \Ord$.
      Choose a map $H$ to $A$ such that $H$ is recursive regarding $G$ and $\alpha \Elem \Dom(H)$ and $F(\alpha) \Eq H(\alpha)$.

      Let us show that $F(\beta) \Eq H(\beta)$ for all $\beta \Elem \alpha$.
        Let $\beta \Elem \alpha$.
        Choose a map $H'$ to $A$ such that $H'$ is recursive regarding $G$ and $\beta \Elem \Dom(H')$ and $F(\beta) \Eq H'(\beta)$.
        [prover vampire]
        Then $H(\beta) \Eq H'(\beta)$ (by \sn{coincidence lemma}).
        Indeed $\beta \Elem \Dom(H) \SETintersect \Dom(H')$.
        Therefore $F(\beta) \Eq H'(\beta)$.
      End.

      Hence $H \FUNrest \alpha \Eq F \FUNrest \alpha$.
      Thus $F(\alpha)
        \Eq H(\alpha)
        \Eq G(H \FUNrest \alpha)
        \Eq G(F \FUNrest \alpha)$.
    \end{proof}
  \end{proof}
\end{proof}

\begin{theorem}[forthel,title=Transfinite Recursion: Uniqueness]
  Let $A$ be a class and $G$ be a map from $\ORDfunspace{A}$ to $A$.
  Let $F, F'$ be maps from $\Ord$ to $A$ that are recursive regarding $G$.
  Then $F \Eq F'$.
\end{theorem}
\begin{proof}[forthel]
  [prover vampire]
  $F$ and $F'$ are recursive regarding $G$.
  Then $F(\alpha) \Eq F'(\alpha)$ for all $\alpha \Elem \Dom(F) \SETintersect \Dom(F')$ (by \sn{coincidence lemma}).
  We have $\Dom(F) \Eq \Ord \Eq \Dom(F')$.
  Hence $F(\alpha) \Eq F'(\alpha)$ for all $\alpha \Elem \Ord$.
  Thus $F \Eq F'$.
\end{proof}

As a corollary of the transfinite recursion theorem we get that we can
define maps recursively on the ordinals by case distinction:
For given maps $G \FUNfromto{\Ord \SETprod A}{A}$ and
$H \FUNfromto{\Ord \SETprod \ORDfunspace{A}}{A}$ and an element $a \Elem A$ we
can define a map $F \FUNfromto{\Ord}{A}$ by
\begin{itemize}
  \item $F(\ORDzero) \DefEq a$,
  \item $F(\ORDsucc(\alpha)) \DefEq G(\alpha, F(\alpha))$, and
  \item $F(\lambda) \DefEq H(\lambda, F \FUNrest \lambda)$
    for any limit ordinal $\lambda$.
\end{itemize}

\begin{lemma}[forthel]
  Let $A$ be a class and $\alpha$ be an ordinal and $F \FUNfromto{\Ord}{A}$.
  Then $(\alpha, F(\alpha)) \Elem \Ord \SETprod A$.
\end{lemma}

\begin{lemma}[forthel]
  Let $A$ be a class and $\lambda$ be a limit ordinal and $F \FUNfromto{\Ord}{A}$.
  Then $(\lambda, F \FUNrest \lambda) \Elem \Ord \SETprod \ORDfunspace{A}$.
\end{lemma}

\begin{corollary}[forthel]
  Let $A$ be a class.
  Let $a \Elem A$ and $G \FUNfromto{\Ord \SETprod A}{A}$ and\linebreak $H \FUNfromto{\Ord \SETprod \ORDfunspace{A}}{A}$.
  Then there exists a map $F$ from $\Ord$ to $A$ such that
  \[ F(\ORDzero) \Eq a \]
  and for all ordinals $\alpha$ we have
  \[ F(\ORDsucc(\alpha)) \Eq G(\alpha, F(\alpha)) \]
  and for all limit ordinals $\lambda$ we have
  \[ F(\lambda) \Eq H(\lambda, F \FUNrest \lambda). \]
\end{corollary}
\begin{proof}[forthel]
  $(\ORDpred(\Dom(f)), f(\ORDpred(\Dom(f)))) \Elem \Ord \SETprod A$ for all $f \Elem \ORDfunspace{A}$ such that $\Dom(f)$ is a successor ordinal.

  Define  \[ J(f) =
    \begin{cases}
      a
      & : \Dom(f) \Eq \ORDzero
      \\
      G(\ORDpred(\Dom(f)), f(\ORDpred(\Dom(f))))
      & : \text{$\Dom(f)$ is a successor ordinal}
      \\
      H(\Dom(f), f)
      & : \text{$\Dom(f)$ is a limit ordinal}
    \end{cases} \]
  for $f \Elem \ORDfunspace{A}$.

  Then $J$ is a map from $\ORDfunspace{A}$ to $A$.
  Indeed we can show that for any $f \Elem \ORDfunspace{A}$ we have $J(f) \Elem A$.
    Let $f \Elem \ORDfunspace{A}$.
    Take $\alpha \Elem \Ord$ such that $f \FUNfromto{\alpha}{A}$.
    If $\alpha \Eq \ORDzero$ then $J(f) \Eq a \Elem A$.
    If $\alpha$ is a successor ordinal then $J(f) \Eq\linebreak G(\ORDpred(\alpha), f(\ORDpred(\alpha))) \Elem A$.
    [prover vampire]
    If $\alpha$ is a limit ordinal then $J(f) \Eq H(\alpha, f) \Elem A$.
  End.

  Hence we can take a map $F$ from $\Ord$ to $A$ that is recursive regarding $J$.
  Then $F \FUNrest \alpha \Elem \ORDfunspace{A}$ for any ordinal $\alpha$.

  (1) $F(\ORDzero) \Eq a$.
  \begin{proof}
    $F(\ORDzero)
      \Eq J(F \FUNrest \ORDzero)
      \Eq a$.
  \end{proof}

  (2) $F(\ORDsucc(\alpha)) \Eq G(\alpha, F(\alpha))$ for all ordinals $\alpha$.
  \begin{proof}
    Let $\alpha$ be an ordinal.
    Then $F(\ORDsucc(\alpha))
      \Eq J(F \FUNrest \ORDsucc(\alpha))
      \Eq\linebreak G(\ORDpred(\ORDsucc(\alpha)), (F \FUNrest \ORDsucc(\alpha))(\ORDpred(\ORDsucc(\alpha))))
      \Eq G(\alpha, (F \FUNrest \ORDsucc(\alpha))(\alpha))
      \Eq\linebreak G(\alpha, F(\alpha))$.
  \end{proof}

  (3) $F(\lambda) \Eq H(\lambda, F \FUNrest \lambda)$ for all limit ordinals $\lambda$.
  \begin{proof}
    Let $\lambda$ be a limit ordinal.
    Then $F(\lambda)
      \Eq J(F \FUNrest \lambda)
      \Eq H(\lambda, F \FUNrest \lambda)$.
  \end{proof}

  Hence the thesis (by 1, 2, 3).
\end{proof}

\printbibliography
\printlicense[CcByNcSa]{Marcel Schütz (2024--2025)}
\end{smodule}
\end{document}
